---
title: "final project 1"
author: "Rachael Jaffe"
date: "09/11/2021"
output: html_document
---
## Libraries and initialize
```{r}
library(tidyverse)
library(readxl)
library(janitor)
library(lubridate) 
library(purrr)

dir <- setwd(getwd())

```


## Read in data
```{r}
deathtable_expansion <- read_xlsx("deathtable_expansion.xlsx")
deathtable_expansion <- deathtable_expansion %>% mutate(Population = as.numeric(Population))

combined <- deathtable_expansion %>% group_by(State, Year) %>% mutate(all_deaths = sum(Deaths), all_pop = sum(Population, na.rm=TRUE), rate = all_deaths/all_pop) %>% distinct(State, Year, .keep_all = TRUE) %>% select(State, Year, all_deaths, all_pop, rate)
  
education <- read_xls("Education_state.xls") 
education <- education[-c(1,2,3),]
education <- education %>% row_to_names(row_number = 1)
education <- education %>% select(State, `Percent of adults with less than a high school diploma, 2015-19`:`Percent of adults with a bachelor's degree or higher, 2015-19`)


unemployment <- read_xlsx("Unemployment (1).xlsx")
unemployment<- unemployment[-c(1,2,3),]
unemployment<- unemployment %>% row_to_names(row_number = 1)
unemployment <- unemployment %>% select(State, Area_name, Employed_2010:Med_HH_Income_Percent_of_State_Total_2019)
unemployment1 <- education %>% left_join(unemployment, by = "State") %>% distinct(State, `Percent of adults with less than a high school diploma, 2015-19`, .keep_all=TRUE)

```

```{r}
# unemployment2 <- unemployment1 %>% group_by(State) %>% slice(rep(1:n(), each = 10))
# unemployment2$year <- rep_len(2010:2019, length.out =530)
# unemployment3 <- unemployment2 %>% select(State, Area_name, year, `Percent of adults with less than a high school diploma, 2015-19`:`Percent of adults with a bachelor's degree or higher, 2015-19`, Employed_2010: Med_HH_Income_Percent_of_State_Total_2019)
# 
# ## cols - state, area_name, year, education1, education2, education3, employment1, unemployment, rate, laborforce
# # unemployment4 <- unemployment4 %>% mutate(less_highschool = , highschool = , some_college = , bachelor_higher = ,  employed = , unemployed = , unemploy_rate = , labor_force = ,)
# 
# unemployment3 %>% group_by(State) %>% group_modify()
```

```{r}
expansion_date <- read_excel("ExpansionData.xlsx")
expansion_date <- expansion_date %>% rename(date = `Expansion date`)
expansion_date[ expansion_date == "NA" ] <- NA
expansion_date <- expansion_date %>% mutate(date = as.numeric(date))
expansion_date <- expansion_date %>% mutate_at(vars(date), ~as.Date(., origin = "1899-12-30"))

```

```{r}
age_data_0 <- read.csv("Age data.csv")
age_data1 <- age_data_0[-c(1:4)]
age_data1 <- age_data1[-c(4)]
colnames(age_data1) <- c("name", "sex", "age", "2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017", "2018", "2019")
age_data1 <- age_data1[!(age_data1$age ==999),] 
age_data1["age"][age_data1["age"] == 0] <- 1.00000000000001 ## changes age 0 to 1 so that we can get the total people

age_data1 <- age_data1 %>% mutate(across(contains('20'),  ## does age * # people per year so we can do the median
                                         .fns = list(f = ~(.*age)), 
                                         .names = "{col}_{fn}")) 
                                  
age_data2 <- age_data1 %>% filter(name != "United States") 

age_data3 <- age_data2 %>% group_by(name) %>% mutate(across(contains('20'),  ## does age * # people per year so we can do the median
                                                            .fns = list(s = ~(sum(.))), 
                                                            .names = "{col}_{fn}")) 
age_data4 <- age_data3 %>% distinct(name, .keep_all=TRUE) %>% select(-c(sex, age)) %>% select(name, c(`2010_s`:`2019_f_s`))

patterns <- unique(substr(names(age_data4), 1, 4))  # store patterns in a vector
patterns <- patterns[-1]
new <- data.frame(sapply(patterns, function(x) age_data4[,grep(x, names(age_data4))][2] / age_data4[,grep(x, names(age_data4))][1]))  # loop through
final <- new %>% cbind(age_data4$name)
colnames(final) <- c("2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017", "2018", "2019", "State")
final <- final %>% select(State, c(`2010`:`2019`))
final <- final %>% pivot_longer(cols = c(`2010`:`2019`), names_to = "year")
final <- final %>% rename("Mean_Age" = value)
```


## Concat data
```{r}

final_data <- unemployment1 %>% full_join(deathtable_expansion, by.x="State", by.y="State")
final_data <- final_data %>% full_join(expansion_date, by="State")
```
